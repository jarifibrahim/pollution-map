<!DOCTYPE html>
<html>
<head>
    <title>My Maps Test</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="markerclusterer.js"></script>
</head>
<style type="text/css">
html,
body {
    height: 100%;
    margin: 0;
}

#map {
    min-height: 100%;
}
</style>

<body>
    <div id="map"></div>
    <script type="text/javascript">
    function initMap() {
        // Create the map.
        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 7,
            center: {
                lat: 20.9174534,
                lng: 74.769278
            },
        });

        var all_data;
        $.ajax({
            url: "http://localhost:3000",
            success: function(data) {
                var color_list = [
                    '#FF0000', '#FFFF00', '#00FF00', '#00FFFF', '#00DD00', '#009900'
                ];
                console.log("AJAX Request successfull")
                marker_data = [];
                data.forEach(function(loc) {
                    var color_choice = color_list[Math.floor(Math.random() * color_list.length)];
                    var myLatlng = new google.maps.LatLng(loc.lat, loc.lon);
                    var cityCircle = create_new_circle(myLatlng, color_choice);
                    var infowindow = new google.maps.InfoWindow({
                        content: loc.name
                    });
                    var marker = new google.maps.Marker({
                        position: myLatlng,
                        map: map,
                        infowindow: infowindow
                    });
                    // http://stackoverflow.com/questions/37800681/google-maps-v3-markerclusterer-add-circle-to-visible-markers-only
                    cityCircle.bindTo('center', marker, 'position');
                    cityCircle.bindTo('map', marker, 'map');
                    google.maps.event.addListener(marker, 'click', function() {
                        this.infowindow.open(map, this)
                    });
                    marker_data.push(marker);
                });

                var markerCluster = new MarkerClusterer(map, marker_data, {
                    imagePath: 'images/m'
                });
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("AJAX Request Failed")
                alert("Unable to retrieve pollution data from the server.\nPlease try again later.")
            },
        });

        function add_markers(data) {
            var color_list = [
                '#FF0000', '#FFFF00', '#00FF00', '#00FFFF', '#00DD00', '#009900'
            ];
            console.log("AJAX Request successfull")
            marker_data = [];
            data.forEach(function(loc) {
                // Add the circle for this city to the map.
                color_index = Math.floor(Math.random() * color_list.length);
                color_choice = color_list[color_index];
                var myLatlng = new google.maps.LatLng(loc.lat, loc.lon);
                var cityCircle = create_new_circle(myLatlng, color_choice);
                var infowindow = new google.maps.InfoWindow({
                    content: loc.name
                });
                var marker = new google.maps.Marker({
                    position: myLatlng,
                    map: map,
                    infowindow: infowindow
                });
                google.maps.event.addListener(marker, 'click', function() {
                    this.infowindow.open(map, this)
                });
                marker_data.push(marker);
            });
            var markerCluster = new MarkerClusterer(map, marker_data, {
                imagePath: 'images/m'
            });
        }

        function create_new_circle(latlng, color_choice) {
            return new google.maps.Circle({
                strokeColor: color_choice,
                fillColor: color_choice,
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillOpacity: 0.35,
                map: map,
                center: latlng,
                radius: 5000,
            });
        }
    }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyChCrc04cczIEwVByskXo2YhuyMf35RyKQ&callback=initMap">
    </script>
    <script type="text/javascript" src="markerclusterer.js"></script>
</body>

</html>
